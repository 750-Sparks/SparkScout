<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Details - SparkScout</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1>
        <a href="/" class="header-link">SparkScout - VEX Competitions</a>
    </h1>

    <div class="team-details">
        <h2>{{ team.team_name }} ({{ team.number }})</h2>
        <p><strong>Organization:</strong> {{ team.organization }}</p>
        <p><strong>Grade:</strong> {{ team.grade }}</p>
        <p><strong>Location:</strong> {{ team.location.city }}, {{ team.location.region }}, {{ team.location.country }}</p>

        <h3>Skills Challenge</h3>
        {% if skills and skills.data %}
            {% set programming_skills = skills.data | selectattr("type", "equalto", "programming") | list %}
            {% set driver_skills = skills.data | selectattr("type", "equalto", "driver") | list %}

            <script>
                const skillsData = JSON.parse('{{ skills.data | tojson | safe }}');
                const programmingSkills = JSON.parse('{{ programming_skills | tojson | safe }}');
                const driverSkills = JSON.parse('{{ driver_skills | tojson | safe }}');

                console.log("Skills Data:", skillsData);
                console.log("Programming Skills:", programmingSkills);
                console.log("Driver Skills:", driverSkills);
            </script>

            <p><strong>Programming Skills:</strong> 
                {% if programming_skills %}
                    {{ programming_skills[0].score }}
                {% else %}
                    N/A
                {% endif %}
            </p>

            <p><strong>Driver Skills:</strong> 
                {% if driver_skills %}
                    {{ driver_skills[0].score }}
                {% else %}
                    N/A
                {% endif %}
            </p>

            <p><strong>Combined Skills:</strong> 
                {% if programming_skills and driver_skills %}
                    {{ programming_skills[0].score + driver_skills[0].score }}
                {% else %}
                    N/A
                {% endif %}
            </p>
        {% else %}
            <p>No skills data available for this team.</p>
        {% endif %}

        <h3>Performance Metrics</h3>
        <p><strong>OPR:</strong> N/A</p>
        <p><strong>DPR:</strong> N/A</p>
        <p><strong>CCWM:</strong> N/A</p>
        <p><strong>WP:</strong> N/A</p>
        <p><strong>AP:</strong> N/A</p>
        <p><strong>SP:</strong> N/A</p>

        <!-- Notes Section -->
        <h3>Notes</h3>

        <!-- Autonomous Details -->
        <div class="note-box">
            <h4>Autonomous Details</h4>
            <form id="autonomousForm" class="note-form">
                <textarea id="autonomousInput" placeholder="Add notes about autonomous..." required></textarea>
                <button type="submit">Save Note</button>
            </form>
            <div id="autonomousNotesList" class="notes-list">
                {% for note in notes_by_type["Autonomous Details"] %}
                    <p>{{ note }}</p>
                {% endfor %}
            </div>
        </div>

        <!-- Endgame Details -->
        <div class="note-box">
            <h4>Endgame Details</h4>
            <form id="endgameForm" class="note-form">
                <textarea id="endgameInput" placeholder="Add notes about endgame..." required></textarea>
                <button type="submit">Save Note</button>
            </form>
            <div id="endgameNotesList" class="notes-list">
                {% for note in notes_by_type["Endgame Details"] %}
                    <p>{{ note }}</p>
                {% endfor %}
            </div>
        </div>

        <!-- Driver Details -->
        <div class="note-box">
            <h4>Driver Details</h4>
            <form id="driverForm" class="note-form">
                <textarea id="driverInput" placeholder="Add notes about drivers..." required></textarea>
                <button type="submit">Save Note</button>
            </form>
            <div id="driverNotesList" class="notes-list">
                {% for note in notes_by_type["Driver Details"] %}
                    <p>{{ note }}</p>
                {% endfor %}
            </div>
        </div>

        <!-- Misc -->
        <div class="note-box">
            <h4>Misc</h4>
            <form id="miscForm" class="note-form">
                <textarea id="miscInput" placeholder="Add miscellaneous notes..." required></textarea>
                <button type="submit">Save Note</button>
            </form>
            <div id="miscNotesList" class="notes-list">
                {% for note in notes_by_type["Misc"] %}
                    <p>{{ note }}</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        const teamId = window.location.pathname.split('/').pop();

        async function saveNote(event, noteType) {
            event.preventDefault(); // Prevent form submission from reloading the page

            // Map note types to their corresponding input IDs
            const inputIdMap = {
                "Autonomous Details": "autonomousInput",
                "Endgame Details": "endgameInput",
                "Driver Details": "driverInput",
                "Misc": "miscInput",
            };

            const inputId = inputIdMap[noteType];
            const note = document.getElementById(inputId).value;

            if (!note) {
                alert("Please enter a note.");
                return;
            }

            try {
                const response = await fetch(`/api/team/${teamId}/notes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ note_type: noteType, note }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Failed to save note.");
                }

                const data = await response.json();
                if (data.message) {
                    alert("Note saved successfully!");
                    document.getElementById(inputId).value = ''; // Clear the input
                    loadNotes(noteType); // Refresh the notes list
                }
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred while saving the note.");
            }
        }

        async function loadNotes(noteType) {
            try {
                const response = await fetch(`/api/team/${teamId}/notes`);
                if (!response.ok) {
                    throw new Error("Failed to load notes.");
                }

                const data = await response.json();
                const notesList = document.getElementById(`${noteType.toLowerCase().replace(/ /g, '')}NotesList`);
                notesList.innerHTML = ''; // Clear existing notes

                // Filter notes by type and display them
                data.notes
                    .filter(note => note.note_type === noteType)
                    .forEach(note => {
                        const noteElement = document.createElement('p');
                        noteElement.textContent = note.note;
                        notesList.appendChild(noteElement);
                    });
            } catch (error) {
                console.error("Error loading notes:", error);
            }
        }

        // Attach event listeners to the forms
        document.getElementById('autonomousForm').addEventListener('submit', (event) => saveNote(event, "Autonomous Details"));
        document.getElementById('endgameForm').addEventListener('submit', (event) => saveNote(event, "Endgame Details"));
        document.getElementById('driverForm').addEventListener('submit', (event) => saveNote(event, "Driver Details"));
        document.getElementById('miscForm').addEventListener('submit', (event) => saveNote(event, "Misc"));

        // Load notes when the page loads
        loadNotes("Autonomous Details");
        loadNotes("Endgame Details");
        loadNotes("Driver Details");
        loadNotes("Misc");
    </script>
</body>
</html>